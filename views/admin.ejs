<%- include('partials/header') %> <%- include('partials/navbar') %>

<div class="container" style="margin-top: 3rem">
  <header class="feed-header">
    <h1
      style="
        font-size: 2.5rem;
        background: linear-gradient(to right, #3b82f6, #10b981);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      "
    >
      Admin Dashboard
    </h1>
    <p style="color: var(--text-muted); font-size: 1.1rem">
      Manage users and view platform statistics
    </p>
  </header>

  <!-- Statistics Cards -->
  <div
    style="
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 3rem;
    "
  >
    <div class="glass-panel" style="padding: 1.5rem; border-radius: 1rem">
      <h3
        style="
          color: var(--text-muted);
          font-size: 0.875rem;
          margin-bottom: 0.5rem;
        "
      >
        Total Users
      </h3>
      <p style="font-size: 2.5rem; font-weight: 700; color: var(--text-main)">
        <%= stats.total %>
      </p>
    </div>
    <div class="glass-panel" style="padding: 1.5rem; border-radius: 1rem">
      <h3
        style="
          color: var(--text-muted);
          font-size: 0.875rem;
          margin-bottom: 0.5rem;
        "
      >
        Active Users
      </h3>
      <p
        style="font-size: 2.5rem; font-weight: 700; color: var(--primary-color)"
      >
        <%= stats.active %>
      </p>
    </div>
    <div class="glass-panel" style="padding: 1.5rem; border-radius: 1rem">
      <h3
        style="
          color: var(--text-muted);
          font-size: 0.875rem;
          margin-bottom: 0.5rem;
        "
      >
        Suspended
      </h3>
      <p style="font-size: 2.5rem; font-weight: 700; color: #ef4444">
        <%= stats.suspended %>
      </p>
    </div>
    <div class="glass-panel" style="padding: 1.5rem; border-radius: 1rem">
      <h3
        style="
          color: var(--text-muted);
          font-size: 0.875rem;
          margin-bottom: 0.5rem;
        "
      >
        Admins
      </h3>
      <p style="font-size: 2.5rem; font-weight: 700; color: #3b82f6">
        <%= stats.admins %>
      </p>
    </div>
  </div>

  <!-- Users Table -->
  <div
    class="glass-panel"
    style="padding: 2rem; border-radius: 1rem; margin-bottom: 4rem"
  >
    <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1.5rem">
      User Management
    </h2>

    <div style="overflow-x: auto">
      <table style="width: 100%; border-collapse: collapse">
        <thead>
          <tr style="border-bottom: 1px solid var(--glass-border)">
            <th
              style="
                padding: 1rem;
                text-align: left;
                color: var(--text-muted);
                font-weight: 600;
              "
            >
              Username
            </th>
            <th
              style="
                padding: 1rem;
                text-align: left;
                color: var(--text-muted);
                font-weight: 600;
              "
            >
              Role
            </th>
            <th
              style="
                padding: 1rem;
                text-align: left;
                color: var(--text-muted);
                font-weight: 600;
              "
            >
              Status
            </th>
            <th
              style="
                padding: 1rem;
                text-align: left;
                color: var(--text-muted);
                font-weight: 600;
              "
            >
              Joined
            </th>
            <th
              style="
                padding: 1rem;
                text-align: left;
                color: var(--text-muted);
                font-weight: 600;
              "
            >
              Last Login
            </th>
            <th
              style="
                padding: 1rem;
                text-align: left;
                color: var(--text-muted);
                font-weight: 600;
              "
            >
              Actions
            </th>
          </tr>
        </thead>
        <tbody>
          <% users.forEach(u => { %>
          <tr style="border-bottom: 1px solid rgba(255, 255, 255, 0.05)">
            <td
              style="padding: 1rem; color: var(--text-main); font-weight: 500"
            >
              <%= u.username %>
            </td>
            <td style="padding: 1rem">
              <span
                style="padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.75rem; font-weight: 600; <%= u.role === 'admin' ? 'background: rgba(59, 130, 246, 0.2); color: #3b82f6;' : 'background: rgba(156, 163, 175, 0.2); color: var(--text-muted);' %>"
              >
                <%= u.role %>
              </span>
            </td>
            <td style="padding: 1rem">
              <span
                style="padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.75rem; font-weight: 600; <%= u.status === 'active' ? 'background: rgba(16, 185, 129, 0.2); color: var(--primary-color);' : u.status === 'suspended' ? 'background: rgba(239, 68, 68, 0.2); color: #ef4444;' : 'background: rgba(156, 163, 175, 0.2); color: var(--text-muted);' %>"
              >
                <%= u.status %>
              </span>
            </td>
            <td
              style="
                padding: 1rem;
                color: var(--text-muted);
                font-size: 0.875rem;
              "
            >
              <%= new Date(u.createdAt).toLocaleDateString() %>
            </td>
            <td
              style="
                padding: 1rem;
                color: var(--text-muted);
                font-size: 0.875rem;
              "
            >
              <%= u.lastLogin ? new Date(u.lastLogin).toLocaleDateString() :
              'Never' %>
            </td>
            <td style="padding: 1rem">
              <div style="display: flex; gap: 0.5rem">
                <% if (u.status === 'active' && u.role !== 'admin') { %>
                <button
                  onclick="suspendUser('<%= u._id %>')"
                  class="btn-outline"
                  style="
                    padding: 0.25rem 0.75rem;
                    font-size: 0.75rem;
                    border-color: #ef4444;
                    color: #ef4444;
                  "
                >
                  Suspend
                </button>
                <% } else if (u.status === 'suspended') { %>
                <button
                  onclick="unsuspendUser('<%= u._id %>')"
                  class="btn-outline"
                  style="
                    padding: 0.25rem 0.75rem;
                    font-size: 0.75rem;
                    border-color: var(--primary-color);
                    color: var(--primary-color);
                  "
                >
                  Unsuspend
                </button>
                <% } %> <% if (u.role !== 'admin' && u._id.toString() !==
                user.userId) { %>
                <button
                  onclick="deleteUser('<%= u._id %>')"
                  class="btn-outline"
                  style="
                    padding: 0.25rem 0.75rem;
                    font-size: 0.75rem;
                    border-color: #ef4444;
                    color: #ef4444;
                  "
                >
                  Delete
                </button>
                <% } %>
              </div>
            </td>
          </tr>
          <% }); %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  async function suspendUser(userId) {
    if (!confirm("Are you sure you want to suspend this user?")) return;

    try {
      const res = await fetch(`/api/admin/users/${userId}/suspend`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
      });

      if (res.ok) {
        alert("User suspended successfully");
        location.reload();
      } else {
        const data = await res.json();
        alert(data.message || "Failed to suspend user");
      }
    } catch (err) {
      console.error(err);
      alert("An error occurred");
    }
  }

  async function unsuspendUser(userId) {
    try {
      const res = await fetch(`/api/admin/users/${userId}/unsuspend`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
      });

      if (res.ok) {
        alert("User unsuspended successfully");
        location.reload();
      } else {
        const data = await res.json();
        alert(data.message || "Failed to unsuspend user");
      }
    } catch (err) {
      console.error(err);
      alert("An error occurred");
    }
  }

  async function deleteUser(userId) {
    if (
      !confirm(
        "Are you sure you want to delete this user? This action cannot be undone."
      )
    )
      return;

    try {
      const res = await fetch(`/api/admin/users/${userId}`, {
        method: "DELETE",
        headers: { "Content-Type": "application/json" },
      });

      if (res.ok) {
        alert("User deleted successfully");
        location.reload();
      } else {
        const data = await res.json();
        alert(data.message || "Failed to delete user");
      }
    } catch (err) {
      console.error(err);
      alert("An error occurred");
    }
  }
</script>

<%- include('partials/footer') %>
